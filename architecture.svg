<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 900" font-family="Inter, -apple-system, sans-serif">
  <defs>
    <filter id="shadow" x="-4%" y="-4%" width="108%" height="108%">
      <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.1"/>
    </filter>
    <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#6366f1"/>
      <stop offset="100%" style="stop-color:#8b5cf6"/>
    </linearGradient>
    <linearGradient id="sessionGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#f0fdf4"/>
      <stop offset="100%" style="stop-color:#dcfce7"/>
    </linearGradient>
    <linearGradient id="toolGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#eff6ff"/>
      <stop offset="100%" style="stop-color:#dbeafe"/>
    </linearGradient>
    <marker id="arrowGray" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8"/>
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#8b5cf6"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#22c55e"/>
    </marker>
    <marker id="arrowOrange" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f97316"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1200" height="900" fill="#fafafa" rx="12"/>

  <!-- Title -->
  <text x="600" y="40" text-anchor="middle" font-size="22" font-weight="700" fill="#1e1b4b">MPC-SE2 â€” Public MCP Server Architecture</text>
  <text x="600" y="62" text-anchor="middle" font-size="13" fill="#6b7280">Multi-session HTTP transport with per-session isolation</text>

  <!-- ==================== CLIENTS (Left Side) ==================== -->
  <text x="100" y="105" text-anchor="middle" font-size="13" font-weight="600" fill="#6b7280" letter-spacing="1">CLIENTS</text>

  <!-- Client 1: Claude Code -->
  <rect x="20" y="120" width="160" height="64" rx="10" fill="white" stroke="#e2e8f0" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="100" y="148" text-anchor="middle" font-size="20">ğŸ¤–</text>
  <text x="100" y="170" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">Claude Code</text>

  <!-- Client 2: Cursor -->
  <rect x="20" y="204" width="160" height="64" rx="10" fill="white" stroke="#e2e8f0" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="100" y="232" text-anchor="middle" font-size="20">âŒ¨ï¸</text>
  <text x="100" y="254" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">Cursor / IDE</text>

  <!-- Client 3: Custom Agent -->
  <rect x="20" y="288" width="160" height="64" rx="10" fill="white" stroke="#e2e8f0" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="100" y="316" text-anchor="middle" font-size="20">ğŸ”§</text>
  <text x="100" y="338" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">Custom Agent</text>

  <!-- Client 4: Local Dev (stdio) -->
  <rect x="20" y="400" width="160" height="64" rx="10" fill="white" stroke="#f97316" stroke-width="1.5" stroke-dasharray="4" filter="url(#shadow)"/>
  <text x="100" y="428" text-anchor="middle" font-size="20">ğŸ’»</text>
  <text x="100" y="450" text-anchor="middle" font-size="12" font-weight="600" fill="#334155">Local Dev (stdio)</text>

  <!-- ==================== ARROWS: Clients â†’ Server ==================== -->
  <!-- HTTP arrows -->
  <line x1="180" y1="152" x2="295" y2="220" stroke="#8b5cf6" stroke-width="2" marker-end="url(#arrowPurple)"/>
  <line x1="180" y1="236" x2="295" y2="236" stroke="#8b5cf6" stroke-width="2" marker-end="url(#arrowPurple)"/>
  <line x1="180" y1="320" x2="295" y2="252" stroke="#8b5cf6" stroke-width="2" marker-end="url(#arrowPurple)"/>

  <!-- HTTP label -->
  <rect x="198" y="168" width="80" height="22" rx="4" fill="#f5f3ff"/>
  <text x="238" y="183" text-anchor="middle" font-size="10" font-weight="600" fill="#7c3aed">POST /mcp</text>
  <rect x="198" y="263" width="80" height="22" rx="4" fill="#f5f3ff"/>
  <text x="238" y="278" text-anchor="middle" font-size="10" font-weight="600" fill="#7c3aed">HTTP + SSE</text>

  <!-- Stdio arrow -->
  <line x1="180" y1="432" x2="295" y2="432" stroke="#f97316" stroke-width="2" stroke-dasharray="6" marker-end="url(#arrowOrange)"/>
  <rect x="198" y="412" width="80" height="22" rx="4" fill="#fff7ed"/>
  <text x="238" y="427" text-anchor="middle" font-size="10" font-weight="600" fill="#ea580c">--stdio</text>

  <!-- ==================== MCP SERVER (Center) ==================== -->
  <rect x="300" y="90" width="520" height="410" rx="14" fill="white" stroke="#c7d2fe" stroke-width="2" filter="url(#shadow)"/>

  <!-- Server header -->
  <rect x="300" y="90" width="520" height="44" rx="14" fill="url(#headerGrad)"/>
  <rect x="300" y="120" width="520" height="14" fill="url(#headerGrad)"/>
  <text x="560" y="118" text-anchor="middle" font-size="15" font-weight="700" fill="white">MPC-SE2 MCP Server (Railway)</text>

  <!-- Express + Transport layer -->
  <rect x="320" y="148" width="480" height="38" rx="8" fill="#faf5ff" stroke="#ddd6fe" stroke-width="1"/>
  <text x="560" y="172" text-anchor="middle" font-size="12" font-weight="600" fill="#6d28d9">Express v5 + StreamableHTTPServerTransport</text>

  <!-- Session Router -->
  <rect x="320" y="198" width="480" height="30" rx="6" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1"/>
  <text x="560" y="218" text-anchor="middle" font-size="11" font-weight="600" fill="#475569">Session Router â€” mcp-session-id header â†’ isolated context</text>

  <!-- Session A -->
  <rect x="328" y="242" width="226" height="244" rx="10" fill="url(#sessionGrad)" stroke="#86efac" stroke-width="1.5"/>
  <text x="441" y="264" text-anchor="middle" font-size="12" font-weight="700" fill="#166534">Session A</text>
  <text x="441" y="280" text-anchor="middle" font-size="10" fill="#4ade80">uuid-aaaa-...</text>

  <!-- Session A internals -->
  <rect x="340" y="290" width="200" height="28" rx="5" fill="white" stroke="#bbf7d0" stroke-width="1"/>
  <text x="440" y="309" text-anchor="middle" font-size="11" fill="#15803d">ğŸ“¦ ProjectStore</text>

  <rect x="340" y="324" width="200" height="28" rx="5" fill="white" stroke="#bbf7d0" stroke-width="1"/>
  <text x="440" y="343" text-anchor="middle" font-size="11" fill="#15803d">âš’ï¸ AnvilManager</text>

  <rect x="340" y="358" width="200" height="28" rx="5" fill="white" stroke="#bbf7d0" stroke-width="1"/>
  <text x="440" y="377" text-anchor="middle" font-size="11" fill="#15803d">ğŸ”§ McpServer (8 tools)</text>

  <!-- Session A projects -->
  <rect x="340" y="394" width="95" height="42" rx="5" fill="#f0fdf4" stroke="#86efac" stroke-width="1"/>
  <text x="388" y="414" text-anchor="middle" font-size="9" font-weight="600" fill="#166534">Project X</text>
  <text x="388" y="428" text-anchor="middle" font-size="8" fill="#4ade80">contracts, tests</text>

  <rect x="445" y="394" width="95" height="42" rx="5" fill="#f0fdf4" stroke="#86efac" stroke-width="1"/>
  <text x="493" y="414" text-anchor="middle" font-size="9" font-weight="600" fill="#166534">Anvil :34521</text>
  <text x="493" y="428" text-anchor="middle" font-size="8" fill="#4ade80">random port</text>

  <!-- Session B -->
  <rect x="566" y="242" width="226" height="244" rx="10" fill="url(#sessionGrad)" stroke="#86efac" stroke-width="1.5"/>
  <text x="679" y="264" text-anchor="middle" font-size="12" font-weight="700" fill="#166534">Session B</text>
  <text x="679" y="280" text-anchor="middle" font-size="10" fill="#4ade80">uuid-bbbb-...</text>

  <!-- Session B internals -->
  <rect x="578" y="290" width="200" height="28" rx="5" fill="white" stroke="#bbf7d0" stroke-width="1"/>
  <text x="678" y="309" text-anchor="middle" font-size="11" fill="#15803d">ğŸ“¦ ProjectStore</text>

  <rect x="578" y="324" width="200" height="28" rx="5" fill="white" stroke="#bbf7d0" stroke-width="1"/>
  <text x="678" y="343" text-anchor="middle" font-size="11" fill="#15803d">âš’ï¸ AnvilManager</text>

  <rect x="578" y="358" width="200" height="28" rx="5" fill="white" stroke="#bbf7d0" stroke-width="1"/>
  <text x="678" y="377" text-anchor="middle" font-size="11" fill="#15803d">ğŸ”§ McpServer (8 tools)</text>

  <rect x="578" y="394" width="95" height="42" rx="5" fill="#f0fdf4" stroke="#86efac" stroke-width="1"/>
  <text x="626" y="414" text-anchor="middle" font-size="9" font-weight="600" fill="#166534">Project Y</text>
  <text x="626" y="428" text-anchor="middle" font-size="8" fill="#4ade80">contracts, tests</text>

  <rect x="683" y="394" width="95" height="42" rx="5" fill="#f0fdf4" stroke="#86efac" stroke-width="1"/>
  <text x="731" y="414" text-anchor="middle" font-size="9" font-weight="600" fill="#166534">Anvil :47892</text>
  <text x="731" y="428" text-anchor="middle" font-size="8" fill="#4ade80">random port</text>

  <!-- Isolation indicator -->
  <line x1="559" y1="250" x2="559" y2="480" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="4"/>
  <text x="559" y="496" text-anchor="middle" font-size="9" font-weight="600" fill="#dc2626">ISOLATED</text>

  <!-- ==================== TOOLS (Right Side) ==================== -->
  <rect x="860" y="90" width="320" height="410" rx="14" fill="url(#toolGrad)" stroke="#93c5fd" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="1020" y="120" text-anchor="middle" font-size="14" font-weight="700" fill="#1e3a5f">8 MCP Tools</text>

  <!-- Tool cards -->
  <rect x="878" y="138" width="140" height="50" rx="8" fill="white" stroke="#bfdbfe" stroke-width="1"/>
  <text x="948" y="160" text-anchor="middle" font-size="11" font-weight="600" fill="#1d4ed8">compile_contracts</text>
  <text x="948" y="178" text-anchor="middle" font-size="9" fill="#64748b">solc + OZ imports</text>

  <rect x="1024" y="138" width="140" height="50" rx="8" fill="white" stroke="#bfdbfe" stroke-width="1"/>
  <text x="1094" y="160" text-anchor="middle" font-size="11" font-weight="600" fill="#1d4ed8">check_security</text>
  <text x="1094" y="178" text-anchor="middle" font-size="9" fill="#64748b">patterns + gas</text>

  <rect x="878" y="198" width="140" height="50" rx="8" fill="white" stroke="#bfdbfe" stroke-width="1"/>
  <text x="948" y="220" text-anchor="middle" font-size="11" font-weight="600" fill="#1d4ed8">run_tests</text>
  <text x="948" y="238" text-anchor="middle" font-size="9" fill="#64748b">forge test -vvv</text>

  <rect x="1024" y="198" width="140" height="50" rx="8" fill="white" stroke="#bfdbfe" stroke-width="1"/>
  <text x="1094" y="220" text-anchor="middle" font-size="11" font-weight="600" fill="#1d4ed8">assemble_project</text>
  <text x="1094" y="238" text-anchor="middle" font-size="9" fill="#64748b">SE2 template</text>

  <rect x="878" y="258" width="140" height="50" rx="8" fill="white" stroke="#bfdbfe" stroke-width="1"/>
  <text x="948" y="280" text-anchor="middle" font-size="11" font-weight="600" fill="#1d4ed8">start_anvil</text>
  <text x="948" y="298" text-anchor="middle" font-size="9" fill="#64748b">local testnet</text>

  <rect x="1024" y="258" width="140" height="50" rx="8" fill="white" stroke="#bfdbfe" stroke-width="1"/>
  <text x="1094" y="280" text-anchor="middle" font-size="11" font-weight="600" fill="#1d4ed8">stop_anvil</text>
  <text x="1094" y="298" text-anchor="middle" font-size="9" fill="#64748b">cleanup</text>

  <rect x="878" y="318" width="140" height="50" rx="8" fill="white" stroke="#bfdbfe" stroke-width="1"/>
  <text x="948" y="340" text-anchor="middle" font-size="11" font-weight="600" fill="#1d4ed8">deploy_local</text>
  <text x="948" y="358" text-anchor="middle" font-size="9" fill="#64748b">forge script</text>

  <rect x="1024" y="318" width="140" height="50" rx="8" fill="white" stroke="#bfdbfe" stroke-width="1"/>
  <text x="1094" y="340" text-anchor="middle" font-size="11" font-weight="600" fill="#1d4ed8">push_github</text>
  <text x="1094" y="358" text-anchor="middle" font-size="9" fill="#64748b">create repo</text>

  <!-- Arrow from sessions to tools -->
  <line x1="800" y1="300" x2="858" y2="300" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrowGray)"/>

  <!-- ==================== FLOW DIAGRAM (Bottom) ==================== -->
  <rect x="20" y="530" width="1160" height="350" rx="14" fill="white" stroke="#e2e8f0" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="600" y="560" text-anchor="middle" font-size="15" font-weight="700" fill="#1e1b4b">Request Flow â€” How a Client Builds a dApp</text>

  <!-- Step boxes -->
  <!-- Step 1 -->
  <rect x="40" y="585" width="155" height="80" rx="10" fill="#faf5ff" stroke="#c4b5fd" stroke-width="1.5"/>
  <text x="118" y="610" text-anchor="middle" font-size="11" font-weight="700" fill="#6d28d9">1. Initialize</text>
  <text x="118" y="628" text-anchor="middle" font-size="10" fill="#7c3aed">POST /mcp</text>
  <text x="118" y="644" text-anchor="middle" font-size="9" fill="#a78bfa">â†’ session-id header</text>
  <text x="118" y="656" text-anchor="middle" font-size="9" fill="#a78bfa">â†’ isolated context</text>
  <line x1="195" y1="625" x2="218" y2="625" stroke="#8b5cf6" stroke-width="2" marker-end="url(#arrowPurple)"/>

  <!-- Step 2 -->
  <rect x="222" y="585" width="155" height="80" rx="10" fill="#eff6ff" stroke="#93c5fd" stroke-width="1.5"/>
  <text x="300" y="610" text-anchor="middle" font-size="11" font-weight="700" fill="#1d4ed8">2. Write Code</text>
  <text x="300" y="628" text-anchor="middle" font-size="10" fill="#3b82f6">Client writes Solidity</text>
  <text x="300" y="644" text-anchor="middle" font-size="9" fill="#60a5fa">contracts + tests</text>
  <text x="300" y="656" text-anchor="middle" font-size="9" fill="#60a5fa">(AI or human)</text>
  <line x1="377" y1="625" x2="400" y2="625" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowGray)"/>

  <!-- Step 3 -->
  <rect x="404" y="585" width="155" height="80" rx="10" fill="#f0fdf4" stroke="#86efac" stroke-width="1.5"/>
  <text x="482" y="610" text-anchor="middle" font-size="11" font-weight="700" fill="#166534">3. Compile</text>
  <text x="482" y="628" text-anchor="middle" font-size="10" fill="#16a34a">compile_contracts</text>
  <text x="482" y="644" text-anchor="middle" font-size="9" fill="#4ade80">solc + OZ v5</text>
  <text x="482" y="656" text-anchor="middle" font-size="9" fill="#4ade80">â†’ ABI + bytecode</text>
  <line x1="559" y1="625" x2="582" y2="625" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>

  <!-- Step 4 -->
  <rect x="586" y="585" width="155" height="80" rx="10" fill="#fefce8" stroke="#fde047" stroke-width="1.5"/>
  <text x="664" y="610" text-anchor="middle" font-size="11" font-weight="700" fill="#854d0e">4. Security</text>
  <text x="664" y="628" text-anchor="middle" font-size="10" fill="#ca8a04">check_security</text>
  <text x="664" y="644" text-anchor="middle" font-size="9" fill="#eab308">reentrancy, gas</text>
  <text x="664" y="656" text-anchor="middle" font-size="9" fill="#eab308">â†’ warnings</text>
  <line x1="741" y1="625" x2="764" y2="625" stroke="#eab308" stroke-width="2" marker-end="url(#arrowGray)"/>

  <!-- Step 5 -->
  <rect x="768" y="585" width="155" height="80" rx="10" fill="#fff1f2" stroke="#fda4af" stroke-width="1.5"/>
  <text x="846" y="610" text-anchor="middle" font-size="11" font-weight="700" fill="#9f1239">5. Test</text>
  <text x="846" y="628" text-anchor="middle" font-size="10" fill="#e11d48">run_tests</text>
  <text x="846" y="644" text-anchor="middle" font-size="9" fill="#fb7185">Foundry forge</text>
  <text x="846" y="656" text-anchor="middle" font-size="9" fill="#fb7185">â†’ pass/fail</text>
  <line x1="923" y1="625" x2="946" y2="625" stroke="#e11d48" stroke-width="2" marker-end="url(#arrowGray)"/>

  <!-- Step 6 -->
  <rect x="950" y="585" width="210" height="80" rx="10" fill="#f0fdf4" stroke="#86efac" stroke-width="1.5"/>
  <text x="1055" y="610" text-anchor="middle" font-size="11" font-weight="700" fill="#166534">6. Assemble + Deploy</text>
  <text x="1055" y="628" text-anchor="middle" font-size="10" fill="#16a34a">assemble_project</text>
  <text x="1055" y="644" text-anchor="middle" font-size="9" fill="#4ade80">start_anvil â†’ deploy_local</text>
  <text x="1055" y="656" text-anchor="middle" font-size="9" fill="#4ade80">push_github</text>

  <!-- Retry loop arrow -->
  <path d="M 846 668 C 846 710, 482 710, 482 668" stroke="#94a3b8" stroke-width="1.5" fill="none" stroke-dasharray="4" marker-end="url(#arrowGray)"/>
  <text x="664" y="724" text-anchor="middle" font-size="10" font-weight="600" fill="#94a3b8">fix &amp; retry loop (up to 5Ã—)</text>

  <!-- Protocol note -->
  <rect x="40" y="750" width="540" height="110" rx="10" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1"/>
  <text x="60" y="774" font-size="12" font-weight="700" fill="#334155">Protocol Details</text>
  <text x="60" y="796" font-size="11" fill="#64748b">Transport: MCP Streamable HTTP (SSE + JSON-RPC 2.0)</text>
  <text x="60" y="814" font-size="11" fill="#64748b">Session: mcp-session-id header (UUID per connection)</text>
  <text x="60" y="832" font-size="11" fill="#64748b">Endpoints: POST/GET/DELETE /mcp + GET /health</text>
  <text x="60" y="850" font-size="11" fill="#64748b">Auth: None (public) â€” add OAuth later via MCP SDK middleware</text>

  <!-- Key properties -->
  <rect x="600" y="750" width="560" height="110" rx="10" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1"/>
  <text x="620" y="774" font-size="12" font-weight="700" fill="#334155">Key Properties</text>
  <text x="620" y="796" font-size="11" fill="#64748b">âœ“ Multi-user: Each session gets isolated state (no cross-talk)</text>
  <text x="620" y="814" font-size="11" fill="#64748b">âœ“ Anvil ports: Random 10000-60000 (no collisions between sessions)</text>
  <text x="620" y="832" font-size="11" fill="#64748b">âœ“ Dual-mode: --stdio for local dev, HTTP (default) for hosted</text>
  <text x="620" y="850" font-size="11" fill="#64748b">âœ“ Cleanup: SIGTERM/session close â†’ stop all Anvil processes</text>

  <!-- Tool hint on right side -->
  <rect x="878" y="385" width="286" height="100" rx="8" fill="#fefce8" stroke="#fde047" stroke-width="1"/>
  <text x="1021" y="410" text-anchor="middle" font-size="11" font-weight="700" fill="#854d0e">Tools never generate code!</text>
  <text x="1021" y="430" text-anchor="middle" font-size="10" fill="#a16207">The AI client writes all Solidity,</text>
  <text x="1021" y="446" text-anchor="middle" font-size="10" fill="#a16207">tests, and frontend code.</text>
  <text x="1021" y="466" text-anchor="middle" font-size="10" fill="#a16207">Tools only compile, test, &amp; deploy.</text>
</svg>
